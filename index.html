<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EliteCoach - Pro Performance</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary: #1e3a8a; --secondary: #2563eb; --success: #10b981;
    --warning: #f59e0b; --danger: #ef4444; --bg: #f4f6f9;
    --sidebar: #ffffff; --text: #1e293b;
}
* { box-sizing: border-box; font-family: 'Arial', sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

#loginDiv { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.login-card { background: white; padding: 2.5rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }

#sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid #ddd; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; }
.sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; color: var(--primary); background: #f8fafc; text-align: center; border-bottom: 1px solid #ddd; }
.nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #555; border-bottom: 1px solid #f1f5f9; }
.nav-item:hover { background: #f4f6f9; }
.nav-item.active { background: var(--secondary); color: white; }

.main-content { flex: 1; padding: 20px; max-width: 1100px; margin: 0 auto; width: 100%; }
.card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #ddd; }
h2 { margin-top: 0; color: var(--primary); font-size: 1.4rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }

table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
th { background: #e5e7eb; font-size: 0.9rem; }

input, select, button { padding: 10px; margin: 5px 0; width: 100%; border-radius: 4px; border: 1px solid #ccc; }
button { background: var(--secondary); color: white; border: none; cursor: pointer; font-weight: bold; }
button:hover { background: #1e40af; }
button.delete { background: #ef4444; width: auto; padding: 5px 10px; }
button.export { background: #10b981; margin-top: 10px; }

.hidden { display: none !important; }
.ratio-badge { padding: 5px 10px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.85rem; }

#campo { background: #2e7d32; border: 3px solid white; cursor: crosshair; display:block; margin: 0 auto; }
.tipo-btn { padding:8px 12px; margin-right:5px; width: auto; display: inline-block; }
.tipo-btn.active { background:#ef4444; color:white; }
</style>
</head>
<body>

<div id="loginDiv">
    <div class="login-card">
        <h2 style="text-align: center; border:none">‚öΩ EliteCoach Login</h2>
        <input type="text" id="loginUser" placeholder="Usuario">
        <input type="password" id="loginPass" placeholder="Contrase√±a">
        <button onclick="login()">Entrar</button>
        <button onclick="register()" style="background: #64748b; margin-top: 10px;">Registrarse</button>
        <div id="loginMsg" style="text-align:center; margin-top: 10px; color: red;"></div>
    </div>
</div>

<nav id="sidebar" class="hidden">
    <div class="sidebar-header">EliteCoach Menu</div>
    <div class="nav-item active" onclick="switchTab(0)"><i class="fas fa-users"></i> Jugadores</div>
    <div class="nav-item" onclick="switchTab(1)"><i class="fas fa-trophy"></i> Partidos</div>
    <div class="nav-item" onclick="switchTab(2)"><i class="fas fa-bullseye"></i> Goles Esperados</div>
    <div class="nav-item" onclick="switchTab(3)"><i class="fas fa-chart-line"></i> Entrenamientos</div>
    <div style="margin-top: auto; padding: 20px;">
        <button class="export" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Exportar Datos</button>
    </div>
</nav>

<main id="app" class="main-content hidden">

    <div id="tab0" class="tab-content">
        <div class="card">
            <h2>Plantilla de Jugadores</h2>
            <input id="nombre" placeholder="Nombre del jugador">
            <button onclick="addJugador()">A√±adir Jugador</button>
            <table>
                <thead>
                    <tr><th>Nombre</th><th>G</th><th>A</th><th>PJ</th><th>Min</th><th>üü®</th><th>üü•</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody id="tablaJugadores"></tbody>
            </table>
        </div>
    </div>

    <div id="tab1" class="tab-content hidden">
        <div class="card">
            <h2>Registro de Partidos</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input id="local" placeholder="Equipo Local">
                <input id="gLocal" type="number" placeholder="Goles L">
                <input id="visitante" placeholder="Equipo Visitante">
                <input id="gVisitante" type="number" placeholder="Goles V">
            </div>
            <input id="desc" placeholder="Descripci√≥n/Notas">
            <button onclick="addPartido()">Guardar Partido</button>
            <table>
                <thead>
                    <tr><th>Partido</th><th>Resultado</th><th>Notas</th><th></th></tr>
                </thead>
                <tbody id="tablaPartidos"></tbody>
            </table>
        </div>
    </div>

    <div id="tab2" class="tab-content hidden">
        <div class="card">
            <h2>Goles Esperados (xG) - Simulador</h2>
            <div id="tipoTiro" style="text-align:center;">
                <button class="tipo-btn active" data-tipo="normal">Tiro Normal</button>
                <button class="tipo-btn" data-tipo="penalti">Penalti</button>
                <button class="tipo-btn" data-tipo="balonparado">Bal√≥n Parado</button>
                <button class="tipo-btn" data-tipo="cabeza">Remate de Cabeza</button>
            </div>
            <canvas id="campo" width="350" height="500" style="margin-top:15px;"></canvas>
            <div style="display:flex; justify-content:space-around; margin-top:15px;">
                <div id="xgActual" style="font-weight:bold;">√öltimo tiro: 0,00</div>
                <div id="xgTotalDisp" style="font-weight:bold;">xG total: 0,00</div>
            </div>
            <button onclick="resetXG()" style="margin-top:15px;">Reiniciar Mapa</button>
        </div>
        <div class="card">
            <h2>Historial de Disparos</h2>
            <table>
                <thead>
                    <tr><th>#</th><th>X</th><th>Y</th><th>Tipo</th><th>xG</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody id="tablaTiros"></tbody>
            </table>
        </div>
    </div>

    <div id="tab3" class="tab-content hidden">
        <div class="card">
            <h2>Nueva Sesi√≥n de Entrenamiento</h2>
            <select id="selectJugadores" multiple style="height: 100px;"></select>
            <button onclick="toggleTodos()" style="background:#64748b; font-size: 0.8rem; width: auto;">Seleccionar Todos</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                <input type="date" id="fecha">
                <input type="number" id="duracion" placeholder="Minutos">
                <input type="number" id="rpe" placeholder="RPE (1-10)">
            </div>
            <button onclick="addEntreno()" style="margin-top: 10px;">Registrar Carga</button>
        </div>

        <div class="card">
            <h2>An√°lisis Individual (Ratio ACWR)</h2>
            <select id="filtroJugador" onchange="calcular()"></select>
            <canvas id="graficaCarga" height="150" style="margin-top:20px;"></canvas>
            <canvas id="graficaRatio" height="150" style="margin-top:20px;"></canvas>
        </div>

        <div class="card">
            <h2>Resumen General de Plantilla</h2>
            <table>
                <thead>
                    <tr><th>Jugador</th><th>Carga 7d</th><th>Media 28d</th><th>Ratio</th></tr>
                </thead>
                <tbody id="tablaResumenBody"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
let currentUser = null, jugadores=[], partidos=[], entrenos=[], tiros=[], xgTotal=0;
let chartCarga, chartRatio;
let tipoActual = "normal";

// PERSISTENCIA
function saveUserData(){ localStorage.setItem('userData_'+currentUser, JSON.stringify({jugadores,partidos,entrenos,tiros,xgTotal})); }
function loadUserData(){ 
    const data = JSON.parse(localStorage.getItem('userData_'+currentUser)||'{}'); 
    jugadores=data.jugadores||[]; partidos=data.partidos||[]; entrenos=data.entrenos||[]; tiros=data.tiros||[]; xgTotal=data.xgTotal||0;
}

// LOGIN
async function hashPassword(pw){
    const msgUint8 = new TextEncoder().encode(pw);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}
async function register(){ const u=loginUser.value.trim(), p=loginPass.value; if(!u||!p) return; let users=JSON.parse(localStorage.getItem('users')||'{}'); users[u]=await hashPassword(p); localStorage.setItem('users',JSON.stringify(users)); loginMsg.innerText="Registrado."; }
async function login(){ 
    const u=loginUser.value.trim(), p=await hashPassword(loginPass.value); 
    const users=JSON.parse(localStorage.getItem('users')||'{}'); 
    if(users[u]===p){ currentUser=u; loginDiv.classList.add('hidden'); app.classList.remove('hidden'); sidebar.classList.remove('hidden'); loadUserData(); renderJugadores(); renderSelect(); renderPartidos(); drawField(); actualizarDisplay(); } 
}
function switchTab(i){ 
    document.querySelectorAll('.nav-item').forEach((t,idx)=>t.classList.toggle('active',idx===i)); 
    document.querySelectorAll('.tab-content').forEach((c,idx)=>c.classList.toggle('hidden',idx!==i)); 
    if(i===3) calcular();
    if(i===2) setTimeout(drawField, 50);
}

// FUNCIONES JUGADORES/PARTIDOS
function addJugador(){ if(!nombre.value) return; jugadores.push({nombre:nombre.value,g:0,a:0,pj:0,min:0,am:0,r:0}); nombre.value=""; renderJugadores(); renderSelect(); saveUserData(); }
function renderJugadores(){ tablaJugadores.innerHTML = jugadores.map((j,i)=>`<tr><td>${j.nombre}</td><td>${j.g}</td><td>${j.a}</td><td>${j.pj}</td><td>${j.min}</td><td>${j.am}</td><td>${j.r}</td><td><button class="delete" onclick="jugadores.splice(${i},1);renderJugadores();saveUserData()">‚ùå</button></td></tr>`).join(''); }
function renderSelect(){ const h=jugadores.map(j=>`<option value="${j.nombre}">${j.nombre}</option>`).join(''); selectJugadores.innerHTML=h; filtroJugador.innerHTML=h; }
function addPartido(){ if(!local.value) return; partidos.push({l:local.value, gl:gLocal.value, v:visitante.value, gv:gVisitante.value, d:desc.value}); renderPartidos(); saveUserData(); }
function renderPartidos(){ tablaPartidos.innerHTML=partidos.map((p,i)=>`<tr><td>${p.l} vs ${p.v}</td><td>${p.gl}-${p.gv}</td><td>${p.d}</td><td><button class="delete" onclick="partidos.splice(${i},1);renderPartidos();saveUserData()">‚ùå</button></td></tr>`).join(''); }

// L√ìGICA ENTRENAMIENTOS (CORREGIDA)
function toggleTodos(){ [...selectJugadores.options].forEach(o=>o.selected=!o.selected); }
function addEntreno(){
    const dur=parseInt(duracion.value), rpeV=parseInt(rpe.value), f=fecha.value;
    if(!dur || !rpeV || !f) return;
    [...selectJugadores.selectedOptions].forEach(o => entrenos.push({n: o.value, fecha: f, carga: dur*rpeV}));
    saveUserData(); calcular();
}
function obtenerRatio(nombre, refStr){
    const ref = new Date(refStr).getTime();
    const aguda = entrenos.filter(e=>e.n===nombre && (ref - new Date(e.fecha).getTime()) >= 0 && (ref - new Date(e.fecha).getTime()) <= 7*86400000).reduce((a,c)=>a+c.carga,0);
    const cronica = entrenos.filter(e=>e.n===nombre && (ref - new Date(e.fecha).getTime()) >= 0 && (ref - new Date(e.fecha).getTime()) <= 28*86400000).reduce((a,c)=>a+c.carga,0)/4;
    return { aguda, cronica, ratio: cronica>0 ? (aguda/cronica).toFixed(2) : 0 };
}
function calcular(){
    const jSel = filtroJugador.value; if(!jSel) return;
    const misSesiones = entrenos.filter(e=>e.n===jSel).sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
    if(chartCarga) chartCarga.destroy();
    chartCarga = new Chart(document.getElementById('graficaCarga'), { type:'bar', data:{labels:misSesiones.slice(-10).map(s=>s.fecha), datasets:[{label:'Carga', data:misSesiones.slice(-10).map(s=>s.carga), backgroundColor:'#2563eb'}]} });
    const labelsR=[], dataR=[];
    for(let i=14;i>=0;i--){
        let d=new Date(); d.setDate(d.getDate()-i); let f=d.toISOString().split('T')[0];
        labelsR.push(f); dataR.push(obtenerRatio(jSel, f).ratio);
    }
    if(chartRatio) chartRatio.destroy();
    chartRatio = new Chart(document.getElementById('graficaRatio'), { type:'line', data:{labels:labelsR, datasets:[{label:'Ratio ACWR', data:dataR, borderColor:'#10b981'}]} });
    const hoy = new Date().toISOString().split('T')[0];
    tablaResumenBody.innerHTML = jugadores.map(j => {
        let r = obtenerRatio(j.nombre, hoy);
        return `<tr><td>${j.nombre}</td><td>${r.aguda}</td><td>${r.cronica.toFixed(0)}</td><td><span class="ratio-badge" style="background:${r.ratio>1.5?'red':r.ratio>1.2?'orange':'green'}">${r.ratio}</span></td></tr>`;
    }).join('');
}

// xG CAMPO REGLAMENTARIO
const campo=document.getElementById("campo"), ctx=campo.getContext("2d");
document.querySelectorAll(".tipo-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tipo-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active"); tipoActual=btn.dataset.tipo;
    });
});
function drawField(){
    ctx.clearRect(0,0,350,500); ctx.fillStyle="#2e7d32"; ctx.fillRect(0,0,350,500);
    ctx.strokeStyle="white"; ctx.lineWidth=2;
    ctx.strokeRect(0,0,350,500); // Borde
    ctx.strokeRect(60,0,230,80); // √Årea Grande
    ctx.strokeRect(125,0,100,30); // √Årea Chica
    ctx.beginPath(); ctx.arc(175,60,2,0,Math.PI*2); ctx.fillStyle="white"; ctx.fill(); // Penalti
    ctx.beginPath(); ctx.arc(175,60,45,0.45,Math.PI-0.45); ctx.stroke(); // Media Luna
    ctx.beginPath(); ctx.moveTo(0,500); ctx.lineTo(350,500); ctx.stroke();
}
campo.addEventListener("click",(e)=>{
    const r=campo.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
    const xg= (tipoActual==="penalti") ? 0.78 : (1/(1+Math.exp((Math.sqrt(Math.pow(x-175,2)+Math.pow(y,2))-50)/15))).toFixed(2);
    xgTotal+=parseFloat(xg); tiros.push({x:x.toFixed(0), y:y.toFixed(0), xg, tipo:tipoActual});
    actualizarDisplay(); saveUserData();
});
function actualizarDisplay(){
    document.getElementById("xgActual").innerText="√öltimo tiro: "+(tiros.length?tiros[tiros.length-1].xg:"0,00");
    document.getElementById("xgTotalDisp").innerText="xG total: "+xgTotal.toFixed(2);
    document.getElementById("tablaTiros").innerHTML=tiros.map((t,i)=>`<tr><td>${i+1}</td><td>${t.x}</td><td>${t.y}</td><td>${t.tipo}</td><td>${t.xg}</td><td><button class="delete-btn" onclick="tiros.splice(${i},1);actualizarDisplay();saveUserData()">‚ùå</button></td></tr>`).join('');
    drawField(); tiros.forEach(t=>{ ctx.beginPath(); ctx.arc(t.x,t.y,4,0,Math.PI*2); ctx.fillStyle="yellow"; ctx.fill(); ctx.stroke(); });
}
function resetXG(){ xgTotal=0; tiros=[]; actualizarDisplay(); saveUserData(); }

// EXPORTAR A EXCEL
function exportToExcel(){
    const wb = XLSX.utils.book_new();
    const wsJ = XLSX.utils.json_to_sheet(jugadores); XLSX.utils.book_append_sheet(wb, wsJ, "Plantilla");
    const wsP = XLSX.utils.json_to_sheet(partidos); XLSX.utils.book_append_sheet(wb, wsP, "Partidos");
    const wsE = XLSX.utils.json_to_sheet(entrenos); XLSX.utils.book_append_sheet(wb, wsE, "Cargas");
    XLSX.writeFile(wb, `EliteCoach_${currentUser}.xlsx`);
}
</script>
</body>
</html>
